<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calling R functions from Fortran • ftest</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calling R functions from Fortran">
<meta property="og:description" content="ftest">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ftest</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/frcall.html">Calling R functions from Fortran</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="frcall_files/header-attrs-2.3/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calling R functions from Fortran</h1>
                        <h4 class="author">Balasubramanian Narasimhan</h4>
            
            <h4 class="date">2020-08-08</h4>
      
      
      <div class="hidden name"><code>frcall.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The <em>Writing R extensions</em> manual actually provides almost all the details for calling R functions from Fortran. This package is a concrete realization of those instructions. There are, however, a few details to note in the interest of portability.</p>
<ul>
<li>The only structures passed to and fro the R function from Fortran are integer and double vectors or matrices.</li>
<li>Strings are problematic and best avoided.</li>
<li>A bit of C glue is needed to make the call to R.</li>
</ul>
</div>
<div id="is-it-even-needed" class="section level2">
<h2 class="hasAnchor">
<a href="#is-it-even-needed" class="anchor"></a>Is it even needed?</h2>
<p>There are times when you would like to allow a user-specified computation to be used in your awesome Fortran routine. In fact, some of the fastest algorithms are implemented in Fortran by Stanford colleagues of mine and they’ve asked me for such a facility.</p>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>Suppose we wish to call the following R function from Fortran in a package, say <code>ftest</code>. It is in the packaging context where such calls are useful anyway.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co">#' Compute a discrepancy measure between y and z weighted by w</span>
<span class="co">#' @param y the first vector</span>
<span class="co">#' @param z the second vector</span>
<span class="co">#' @param w the weights</span>
<span class="co">#' @return a scalar discrepancy measure</span>
<span class="no">discrepancy</span>  <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">y</span>, <span class="no">z</span>, <span class="no">w</span>) {
    <span class="no">w</span>  <span class="kw">&lt;-</span> <span class="no">w</span>/<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">w</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>( <span class="no">w</span> * (<span class="no">y</span> - <span class="no">z</span>)^<span class="fl">2</span> )
}</pre></body></html></div>
<p>An example call:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu">discrepancy</span>(<span class="kw">y</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">10</span>, <span class="kw">z</span> <span class="kw">=</span> <span class="fl">11</span>:<span class="fl">20</span>, <span class="kw">w</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fl">10</span>))</pre></body></html></div>
<pre><code>## [1] 100</code></pre>
</div>
<div id="calling-from-fortran" class="section level2">
<h2 class="hasAnchor">
<a href="#calling-from-fortran" class="anchor"></a>Calling from Fortran</h2>
<p>The steps are as follows, with some being specific to the R function being called. The calling sequence involves two calls that go together in sequence: saving the R function in a place that Fortran can look for it and calling a Fortran function to actually execute the call.</p>
<ol style="list-style-type: decimal">
<li>Write a C function, say <code>src/rcall.c</code> to call the R function as follows. What follows below is the implementation of the <code>discrepancy()</code> function above. You will have to tailor this to each R function you want to call. Note that this requires knowledge of C/C++ interface in R, discussed in the <em>Writing R Extensions</em> manual. The comments below are meant to help.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co">/* Start of section not to be modified */</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="dt">static</span> SEXP rfunc;</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="co">/* Store the R function */</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>SEXP store_rfun(SEXP rfun) {</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>  rfunc = rfun;</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>  <span class="cf">return</span>(R_NilValue);</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>}</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a><span class="co">/* End of section not to be modified */</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a><span class="dt">void</span> F77_NAME(rfcall)(<span class="dt">int</span> *n, <span class="dt">double</span> *y, <span class="dt">double</span> *z, <span class="dt">double</span> *w, <span class="dt">double</span> *result) {</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>  <span class="co">/* </span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a><span class="co">     Ensure you modify the arguments above first for your function,</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a><span class="co">     then modify stuff below to match that.  Note that the length of</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a><span class="co">     the y, z, w arrays has to be passed, and the result is stored</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a><span class="co">     into a variable that Fortran provides `result`.</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a><span class="co">  */</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>  <span class="dt">int</span> num_protected = <span class="dv">0</span>;   <span class="co">/* The number of args protected on stack */</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>  SEXP ry, rz, rw;  <span class="co">/* The R structures we will build below. */</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>  <span class="co">/* Allocate space for the vectors we wish to construct */</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>  PROTECT(ry = allocVector(REALSXP, *n));</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a>  num_protected++;</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a>  PROTECT(rz = allocVector(REALSXP, *n));</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a>  num_protected++;</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true"></a>  PROTECT(rw = allocVector(REALSXP, *n));</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true"></a>  num_protected++;</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true"></a>  <span class="co">/* Now copy the values from Fortran arrays into the R arrays */</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true"></a>  <span class="dt">double</span> *yvec = REAL(ry); <span class="dt">double</span> *zvec = REAL(rz); <span class="dt">double</span> *wvec = REAL(rw);</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; *n; i++) {</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true"></a>    yvec[i] = y[i]; zvec[i] = z[i]; wvec[i] = w[i];</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true"></a>  }</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true"></a></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true"></a>  <span class="co">/* Standard stuff: set up environment and evaluate R function */</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true"></a>  SEXP rho = R_GetCurrentEnv();</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true"></a>  SEXP call = PROTECT(LCONS(rfunc, LCONS(ry, LCONS(rz, LCONS(rw, R_NilValue)))));</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true"></a>  num_protected++;</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true"></a>  SEXP r_result = R_forceAndCall(call, <span class="dv">3</span>, rho);</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true"></a>  <span class="co">/* Examine result length */</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true"></a>  R_len_t len = length(r_result);</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true"></a>  <span class="co">/* Throw error if result is more than one; might bomb anyway */</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true"></a>  <span class="cf">if</span> (len &gt; <span class="dv">1</span>) {</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true"></a>    error(<span class="st">"R discrepancy function result length &gt; 1"</span>);</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true"></a>  }</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true"></a>  *result = REAL(r_result)[<span class="dv">0</span>];</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true"></a>  UNPROTECT(num_protected);</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true"></a>}</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Write a Fortran function to call the C function in step 1.</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode fortran"><code class="sourceCode fortran"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="co">c$$$  Assumes the r function has been set using ftest::save_rfun</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>      <span class="kw">subroutine</span> fcallr(n, y, z, w, res)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>      <span class="dt">integer</span> n</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>      <span class="dt">double</span> <span class="dt">precision</span> y(n), z(n), w(n), res</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>      <span class="kw">call</span> rfcall(n, y, z, w, res)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>      <span class="kw">return</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>      <span class="kw">end</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Write an R function to save the R function where Fortran can find it. This is problem invariant.</li>
</ol>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co">#' Save the function f for calling from fortran</span>
<span class="co">#' @param f the R function to be called using `.Fortran`</span>
<span class="co">#' @useDynLib ftest</span>
<span class="co">#' @export save_rfunc</span>
<span class="no">save_rfunc</span>  <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">f</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html">.Call</a></span>(<span class="st">"store_rfun"</span>, <span class="no">f</span>, <span class="kw">PACKAGE</span> <span class="kw">=</span> <span class="st">"ftest"</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span>(<span class="fl">TRUE</span>)
}</pre></body></html></div>
<ol start="4" style="list-style-type: decimal">
<li>Write the Fortran interface using <code><a href="https://rdrr.io/r/base/Foreign.html">.Fortran()</a></code> call.</li>
</ol>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co">#' Compute the discrepancy using `r_fun` using`fcallr`</span>
<span class="co">#' @param r_fun a function of three parameters</span>
<span class="co">#' @param y the y vector</span>
<span class="co">#' @param z the z wector</span>
<span class="co">#' @param w the weights</span>
<span class="co">#' @return the result of calling `r_fun` with `y`, `z`, `w`.</span>
<span class="no">r_from_f</span>  <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">r_fun</span>, <span class="no">y</span>, <span class="no">z</span>, <span class="no">w</span>) {
    <span class="co">## save the R function to call in C ; fcallr knows to look for it there.</span>
    <span class="kw pkg">ftest</span><span class="kw ns">::</span><span class="fu"><a href="../reference/save_rfunc.html">save_rfunc</a></span>(<span class="no">r_fun</span>)
    <span class="no">u</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Foreign.html">.Fortran</a></span>(<span class="st">"fcallr"</span>,
                  <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">y</span>),
                  <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="no">y</span>),
                  <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="no">z</span>),
                  <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="no">w</span>),
                  <span class="kw">result</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="fl">0</span>), <span class="kw">PACKAGE</span> <span class="kw">=</span> <span class="st">"ftest"</span>)
    <span class="no">u</span>$<span class="no">result</span>
}</pre></body></html></div>
</div>
<div id="test-run" class="section level2">
<h2 class="hasAnchor">
<a href="#test-run" class="anchor"></a>Test Run</h2>
<p>An actual run</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">y</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">10</span>; <span class="no">z</span> <span class="kw">=</span> <span class="fl">11</span>:<span class="fl">20</span>; <span class="no">w</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fl">10</span>);
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Direct R function call: %f\n"</span>, <span class="fu">discrepancy</span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">z</span> <span class="kw">=</span> <span class="no">z</span>, <span class="kw">w</span> <span class="kw">=</span> <span class="no">w</span>)))</pre></body></html></div>
<pre><code>## Direct R function call: 100.000000</code></pre>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Calling R from Fortran: %f\n"</span>, <span class="fu">r_from_f</span>(<span class="no">discrepancy</span>, <span class="no">y</span>, <span class="no">z</span>, <span class="no">w</span>)))</pre></body></html></div>
<pre><code>## Calling R from Fortran: 100.000000</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Balasubramanian Narasimhan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
